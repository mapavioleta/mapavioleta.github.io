<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Violeta CNV üó∫Ô∏è Reprograma-T</title>
    
    <link rel="icon" href="favicon.ico" sizes="any"> 
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta name="theme-color" content="#FFA500">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    
    <style>
    /* Estilos Globais - Vari√°veis mantidas para consist√™ncia dos formul√°rios e tema geral */
    :root {
        --mapa-violeta-cor-destaque: #9b59b6;
        --mapa-violeta-cor-destaque-hover: #8e44ad;
        --mapa-violeta-fundo-form: rgba(34, 28, 53, 0.95);
        --mapa-violeta-borda-form: rgba(155, 89, 182, 0.5);
        --mapa-violeta-cor-texto-form: #e0d0ff;
        --mapa-violeta-fundo-pagina: #0a0a14;
        --color-white: #FFFFFF;
        --font-principal: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        --color-orange: #FFA500; 
        --color-gold: #FFD700; 
        --color-silver: #C0C0C0; 
    }

    /* Reset B√°sico e Configura√ß√µes Globais */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; } 
    body {
        font-family: var(--font-principal);
        background-color: var(--mapa-violeta-fundo-pagina);
        color: var(--color-silver); 
        display: flex;
        flex-direction: column;
        line-height: 1.6;
        overflow: hidden; 
    }

    /* Estrutura da P√°gina Principal */
    .app-main-container { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
    }
    .main-content-area { 
        flex: 1; 
        background-color: var(--mapa-violeta-fundo-pagina); 
        padding: 0; 
    }
    .mapa-violeta-main-area { 
        flex-grow: 1; 
        padding: 20px; 
        overflow-y: auto; 
        display: flex; 
        flex-direction: column; 
    }
    .mapa-violeta-header-secao { 
        text-align: center; 
        margin-bottom: 20px; 
    }
    .mapa-violeta-header-secao h1 { 
        color: var(--mapa-violeta-cor-destaque); 
        font-size: 2em; 
        margin-bottom: 10px; 
        text-shadow: 0 0 8px rgba(155, 89, 182, 0.5); 
    }
    .mapa-violeta-header-secao h1 i { 
        margin-right: 10px; 
    }
    .mapa-violeta-header-secao p.subtitulo-mapa { 
        font-size: 1.05em; 
        color: var(--mapa-violeta-cor-texto-form); 
        max-width: 700px; 
        margin: 0 auto 15px; 
    }

    /* Estilos do Mapa e √çcones */
    #map {
        height: 65vh;
        min-height: 500px;
        width: 100%;
        border-radius: 10px;
        border: 2px solid var(--mapa-violeta-borda-form);
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        margin-bottom: 20px;
        background-color: #e0e0e0;
    }

    .custom-registro-icon {
        font-size: 32px;
        color: var(--mapa-violeta-cor-destaque);
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
    }

    .user-map-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-size: cover;
        background-position: center;
        border: 2px solid var(--mapa-violeta-cor-destaque);
        box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }

    /* Estilos dos Pop-ups */
    .leaflet-popup-content-wrapper {
        background: #ffffff;
        color: #333333;
        border-radius: 8px;
        box-shadow: 0 3px 15px rgba(0,0,0,0.2);
        border: 1px solid #ddd;
    }
    .leaflet-popup-tip {
        background: #ffffff;
    }
    
    .popup-marker-details {
        max-height: 280px;
        overflow-y: auto;
        padding-right: 10px;
    }
    .registro-foto-popup {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 12px;
        background-color: #f0f0f0;
    }
    .popup-marker-details h4 {
        color: var(--mapa-violeta-cor-destaque);
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 1.15em;
    }
    .popup-marker-details p {
        margin-bottom: 6px;
        font-size: 0.9em;
        line-height: 1.5;
        color: #555555;
    }
    .popup-marker-details strong {
        color: #111111;
        font-weight: 600;
    }
    .popup-marker-details small,
    .popup-marker-details small a.link-abrir-perfil-modal {
        color: #777;
        font-weight: normal;
    }
    .popup-marker-details small a.link-abrir-perfil-modal {
        color: var(--mapa-violeta-cor-destaque) !important;
        font-weight: bold;
    }

    /* Estilos das A√ß√µes e Coment√°rios no Pop-up */
    .popup-marker-acoes-admin,
    .popup-marker-comments-section {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #eeeeee;
    }
    .popup-marker-acoes-admin { text-align: right; }
    .popup-marker-acoes-admin .btn-sm { 
        font-size: 0.8em; 
        padding: 4px 10px; 
        margin-left: 8px; 
        border-radius: 4px; 
        border: none; 
        cursor: pointer; 
    }
    .popup-marker-acoes-admin .btn--secondary { background-color: #ffc107; color: #000; }
    .popup-marker-acoes-admin .btn--danger { background-color: #dc3545; color: white; }
    
    .popup-marker-comments-section h5 {
        font-size: 1em;
        color: #333;
        margin-bottom: 10px;
    }
    .map-comment-item {
        background-color: #f7f7f7;
        border-left: 3px solid #e8e8e8;
        padding: 8px 12px;
        border-radius: 4px;
        margin-bottom: 8px;
        color: #444;
    }
    .map-comment-item strong { color: var(--mapa-violeta-cor-destaque); }
    
    .form-comment-marker textarea {
        width: 100%;
        padding: 8px;
        margin-top: 8px;
        margin-bottom: 6px;
        border: 1px solid #cccccc;
        border-radius: 4px;
        background-color: #f9f9f9;
        color: #333;
        font-size: 0.9em;
        min-height: 40px;
        resize: vertical;
    }
    .form-comment-marker textarea:focus {
        border-color: var(--mapa-violeta-cor-destaque);
        outline: none;
        box-shadow: 0 0 0 2.5px rgba(155, 89, 182, 0.2);
    }
    .form-comment-marker button {
        padding: 6px 12px;
        font-size: 0.85em;
        background-color: var(--mapa-violeta-cor-destaque);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        float: right;
    }
    .form-comment-marker button:hover { background-color: var(--mapa-violeta-cor-destaque-hover); }

    /* Formul√°rios Flutuantes e Filtros */
    #cnv-form-expander { 
        position: fixed; 
        bottom: 20px; 
        left: 20px; 
        z-index: 1000; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.3); 
        cursor: pointer; 
        transition: all 0.3s ease; 
    }
    #cnv-form-expander button { 
        background-color: var(--mapa-violeta-cor-destaque); 
        color: white; 
        padding: 10px 15px; 
        border-radius: 25px; 
        border: none; 
        font-size: 1em; 
    }
    #cnv-form-expander button:hover { 
        background-color: var(--mapa-violeta-cor-destaque-hover); 
        transform: scale(1.05); 
    }
    #cnv-form-expander i { margin-right: 8px; }

    .mapa-cnv-form-container { 
        position: fixed; 
        bottom: 70px; 
        left: 20px; 
        max-width: 380px; 
        width: 90%; 
        max-height: calc(100vh - 140px); 
        overflow-y: auto; 
        z-index: 999; 
        background-color: var(--mapa-violeta-fundo-form); 
        padding: 20px; 
        border-radius: 12px; 
        border: 1px solid var(--mapa-violeta-borda-form); 
        box-shadow: 0 6px 25px rgba(0,0,0,0.4); 
        color: var(--mapa-violeta-cor-texto-form); 
        opacity: 0; 
        transform: translateY(30px); 
        visibility: hidden; 
        pointer-events: none; 
        transition: all 0.3s ease; 
    }
    .mapa-cnv-form-container.visible { 
        opacity: 1; 
        transform: translateY(0); 
        visibility: visible; 
        pointer-events: auto; 
    }
    .mapa-cnv-form-container h3 { 
        color: var(--mapa-violeta-cor-destaque); 
        font-size: 1.3em; 
        margin-bottom: 18px; 
        text-align: center; 
    }
    .mapa-cnv-form-container label { 
        display: block; 
        margin: 10px 0 5px 0; 
        color: var(--mapa-violeta-cor-texto-form); 
        font-weight: 500; 
        font-size: 0.85em; 
    }
    .mapa-cnv-form-container textarea, 
    .mapa-cnv-form-container select, 
    .mapa-cnv-form-container input { 
        width: 100%; 
        padding: 9px 12px; 
        background-color: rgba(0,0,0,0.5); 
        border: 1px solid var(--mapa-violeta-borda-form); 
        color: var(--color-white); 
        border-radius: 6px; 
        font-size: 0.9em; 
    }
    .mapa-cnv-form-container textarea { 
        min-height: 60px; 
        resize: vertical; 
    }
    .mapa-cnv-form-container button { 
        padding: 10px 15px; 
        border-radius: 20px; 
        font-weight: bold; 
        font-size: 0.9em; 
        display: block; 
        width: 100%; 
        margin-top: 15px; 
        cursor: pointer; 
    }
    .mapa-cnv-form-container button[type="submit"] { 
        background: linear-gradient(135deg, var(--mapa-violeta-cor-destaque), #8e44ad); 
        color: white; 
        border: none; 
    }
    .mapa-cnv-form-container button#cancel-cnv-form-btn { 
        background-color: #6c757d; 
        color: white; 
        border: none; 
    }

    .mapa-filtros-container { 
        background-color: var(--mapa-violeta-fundo-form); 
        padding: 15px 20px; 
        border-radius: 10px; 
        border: 1px solid var(--mapa-violeta-borda-form); 
        margin-bottom: 20px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.25); 
    }
    .mapa-filtros-container h4 { 
        color: var(--mapa-violeta-cor-destaque); 
        font-size: 1.2em; 
        margin-bottom: 15px; 
        text-align: center; 
    }
    #formFiltrosMapa { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
        gap: 15px; 
    }
    .filtro-grupo { display: flex; flex-direction: column; }
    .filtro-grupo label { 
        font-size: 0.85em; 
        color: var(--mapa-violeta-cor-texto-form); 
        margin-bottom: 5px; 
    }
    .filtro-acoes { 
        grid-column: 1 / -1; 
        display: flex; 
        gap: 10px; 
        justify-content: center; 
        margin-top: 10px; 
    }
    .filtro-acoes .btn-sm { 
        padding: 6px 12px; 
        font-size: 0.85em; 
        border-radius: 5px; 
        border: none; 
        cursor: pointer; 
        background-color: var(--mapa-violeta-cor-destaque); 
        color: white; 
    }
    .filtro-acoes #btnLimparFiltrosMapa { background-color: #6c757d; }
    
    .location-permission-modal { 
        display: none; 
        position: fixed; 
        z-index: 2000; 
        left: 0; 
        top: 0; 
        width: 100%; 
        height: 100%; 
        background-color: rgba(0,0,0,0.7); 
        justify-content: center; 
        align-items: center; 
    }
    .location-permission-modal.visible { display: flex; }
    .location-permission-content { 
        background-color: var(--mapa-violeta-fundo-form); 
        color: var(--mapa-violeta-cor-texto-form); 
        padding: 25px; 
        border-radius: 10px; 
        text-align: center; 
        max-width: 400px; 
    }

    .btn { 
        padding: 8px 16px; 
        border-radius: 5px; 
        border: none; 
        cursor: pointer; 
        font-size: 0.9em; 
    }
    .btn--primary { 
        background-color: var(--mapa-violeta-cor-destaque); 
        color: white; 
    }
    .btn--secondary { background-color: #ffc107; color: #000; }
    .btn--danger { background-color: #dc3545; color: white; }

    @media (max-width: 768px) {
        .mapa-violeta-main-area { padding: 15px; }
        .mapa-violeta-header-secao h1 { font-size: 1.7em; }
        #map { height: 45vh; min-height: 300px; }
    }
    @media (max-width: 480px) {
        .mapa-violeta-main-area { padding: 10px; }
        .mapa-violeta-header-secao h1 { font-size: 1.5em; }
        .mapa-cnv-form-container { 
            bottom: 60px; 
            left: 10px; 
            right: 10px; 
            max-width: none; 
            width: auto; 
            padding: 15px; 
        }
    }
    </style>
</head>
<body class="pagina-mapa-violeta">
    <div class="app-main-container">
        <main class="main-content-area">
            <section class="mapa-violeta-main-area">
                <div class="mapa-violeta-header-secao">
                    <h1><i class="fas fa-map-marked-alt"></i> Mapa Violeta CNV</h1>
                    <p class="subtitulo-mapa">Partilhe suas experi√™ncias e observa√ß√µes. Clique no mapa para adicionar um registro.<br>
                    <span id="location-status-message" style="font-size:0.9em; opacity:0.8;">
                        Para ver outros usu√°rios pr√≥ximos, permita o acesso √† sua localiza√ß√£o.
                    </span></p>
                </div>
                
                <div id="map"></div>

                <!-- Formul√°rio de Filtros -->
                <div class="mapa-filtros-container" id="mapaFiltrosContainer">
                    <h4><i class="fas fa-filter"></i> Filtrar Registros</h4>
                    <form id="formFiltrosMapa">
                        <div class="filtro-grupo">
                            <label for="filtro_tipo_registro">Tipo de Registro:</label>
                            <select name="filtro_tipo_registro" id="filtro_tipo_registro">
                                <option value="">Todos os Tipos</option>
                                <option value="alerta_perigo">üö® Alerta de Perigo</option>
                                <option value="local_acolhedor">üíñ Local Acolhedor</option>
                                <option value="ponto_apoio">ü§ù Ponto de Apoio</option>
                                <option value="evento_positivo">üéâ Evento Positivo</option>
                                <option value="denuncia_violencia">üó£Ô∏è Den√∫ncia</option>
                                <option value="reivindicacao_melhoria">üöß Reivindica√ß√£o</option>
                            </select>
                        </div>
                        <div class="filtro-grupo">
                            <label for="filtro_usuario">Por Usu√°rio (@nick):</label>
                            <input type="text" name="filtro_usuario" id="filtro_usuario" placeholder="Nick do usu√°rio">
                        </div>
                        <div class="filtro-acoes">
                            <button type="submit" class="btn btn--primary btn-sm"><i class="fas fa-search"></i> Aplicar Filtros</button>
                            <button type="button" id="btnLimparFiltrosMapa" class="btn btn-sm"><i class="fas fa-times-circle"></i> Limpar Filtros</button>
                        </div>
                    </form>
                </div>
                
                <div id="cnv-form-expander">
                    <button id="toggle-cnv-form-btn"><i class="fas fa-plus-circle"></i> Novo Registro</button>
                </div>

                <div class="mapa-cnv-form-container" id="mapa-cnv-form">
                    <h3><i class="fas fa-heartbeat"></i> Registrar Experi√™ncia/Observa√ß√£o</h3>
                    <form id="cnv-form-mapa-interno">
                        <input type="hidden" name="action" id="form-action" value="criar">
                        <input type="hidden" name="registro_id_editar" id="form-registro-id-editar">
                        <input type="hidden" name="latitude" id="form-latitude">
                        <input type="hidden" name="longitude" id="form-longitude">
                        <div>
                            <label for="tipo_registro_mapa">Tipo de Registro:*</label>
                            <select name="tipo_registro" id="tipo_registro_mapa" required>
                                <option value="" disabled selected>Selecione...</option>
                                <option value="alerta_perigo">üö® Alerta de Perigo</option>
                                <option value="local_acolhedor">üíñ Local Acolhedor</option>
                                <option value="ponto_apoio">ü§ù Ponto de Apoio</option>
                                <option value="evento_positivo">üéâ Evento Positivo</option>
                                <option value="denuncia_violencia">üó£Ô∏è Den√∫ncia</option>
                                <option value="reivindicacao_melhoria">üöß Reivindica√ß√£o</option>
                            </select>
                        </div>
                        <label for="cnv_observacao_mapa">1. Observa√ß√£o (Fatos)*:</label>
                        <textarea name="observacao" id="cnv_observacao_mapa" required placeholder="Ex: Vi picha√ß√µes..."></textarea>
                        <label for="cnv_sentimento_mapa">2. Sentimento*:</label>
                        <textarea name="sentimento" id="cnv_sentimento_mapa" required placeholder="Ex: Senti medo..."></textarea>
                        <label for="cnv_necessidade_mapa">3. Necessidade*:</label>
                        <textarea name="necessidade" id="cnv_necessidade_mapa" required placeholder="Ex: Necessidade de seguran√ßa..."></textarea>
                        <label for="cnv_pedido_mapa">4. Pedido*:</label>
                        <textarea name="pedido" id="cnv_pedido_mapa" required placeholder="Ex: Gostaria que a prefeitura limpasse..."></textarea>
                        <button type="submit" id="submit-cnv-form-btn"><i class="fas fa-map-marker-alt"></i> Enviar Registro</button>
                        <button type="button" id="cancel-cnv-form-btn">Cancelar</button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <div class="location-permission-modal" id="location-permission-modal">
        <div class="location-permission-content">
            <h3><i class="fas fa-map-marker-alt"></i> Compartilhar Localiza√ß√£o?</h3>
            <p>Para mostrar outros usu√°rios pr√≥ximos no mapa e melhorar sua experi√™ncia, precisamos da sua permiss√£o para acessar sua localiza√ß√£o aproximada. Sua localiza√ß√£o exata nunca ser√° compartilhada.</p>
            <div class="location-permission-buttons">
                <button id="btn-permitir-localizacao" class="btn-permitir">Permitir</button>
                <button id="btn-negar-localizacao" class="btn-negar">Agora N√£o</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
    // Configura√ß√£o
    const CONFIG = {
        API_BASE_URL: 'https://mapavioleta-github-io-3.onrender.com',
        MAP: {
            defaultCenter: [-23.1896, -45.8841],
            defaultZoom: 13
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        // Elementos DOM
        const mapElement = document.getElementById('map');
        const cnvFormExpanderButton = document.getElementById('toggle-cnv-form-btn');
        const cnvFormContainer = document.getElementById('mapa-cnv-form');
        const cnvForm = document.getElementById('cnv-form-mapa-interno');
        const cancelCnvFormBtn = document.getElementById('cancel-cnv-form-btn');
        const latitudeInput = document.getElementById('form-latitude');
        const longitudeInput = document.getElementById('form-longitude');
        const locationStatusMessage = document.getElementById('location-status-message');
        const submitCnvFormBtn = document.getElementById('submit-cnv-form-btn');
        const formFiltrosMapa = document.getElementById('formFiltrosMapa');
        const btnLimparFiltrosMapa = document.getElementById('btnLimparFiltrosMapa');
        const locationModal = document.getElementById('location-permission-modal');
        const btnPermitirLoc = document.getElementById('btn-permitir-localizacao');
        const btnNegarLoc = document.getElementById('btn-negar-localizacao');

        // Vari√°veis de estado
        let currentMapClickMarker;
        let map;
        let cnvMarkersLayer = L.layerGroup();
        let allCnvMarkersData = [];
        let currentFilters = {};

        // Fun√ß√µes do Mapa
        function initMap() {
            map = L.map(mapElement).setView(CONFIG.MAP.defaultCenter, CONFIG.MAP.defaultZoom);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            cnvMarkersLayer.addTo(map);

            // Evento de clique no mapa
            map.on('click', (e) => {
                if (currentMapClickMarker) map.removeLayer(currentMapClickMarker);
                currentMapClickMarker = L.marker(e.latlng).addTo(map);
                latitudeInput.value = e.latlng.lat;
                longitudeInput.value = e.latlng.lng;
                toggleCnvForm(true);
            });

            loadMapMarkers();
        }

        // Carregar marcadores
        async function loadMapMarkers() {
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/?action=get-pontos`);
                const resultado = await response.json();
                
                cnvMarkersLayer.clearLayers();
                allCnvMarkersData = [];
                
                if (resultado.success && resultado.data) {
                    allCnvMarkersData = resultado.data;
                    allCnvMarkersData.forEach(addCnvMarkerToMap);
                }
            } catch (error) {
                console.error('Erro ao carregar marcadores:', error);
            }
        }

        // Adicionar marcador ao mapa
        function addCnvMarkerToMap(ponto) {
            const emojiMap = { 
                'alerta_perigo': 'üö®', 
                'local_acolhedor': 'üíñ', 
                'ponto_apoio': 'ü§ù', 
                'evento_positivo': 'üéâ', 
                'denuncia_violencia': 'üó£Ô∏è', 
                'reivindicacao_melhoria': 'üöß' 
            };
            const emoji = emojiMap[ponto.tipo_registro] || 'üìç';
            
            const customIcon = L.divIcon({
                html: `<div style="font-size: 24px;">${emoji}</div>`,
                className: 'custom-emoji-icon', 
                iconSize: [32, 32], 
                iconAnchor: [16, 32], 
                popupAnchor: [0, -32]
            });

            const marker = L.marker([ponto.latitude, ponto.longitude], { icon: customIcon });
            
            const popupContent = `
                <div class="popup-marker-details">
                    <h4>${ponto.tipo_registro ? ponto.tipo_registro.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Registro'}</h4>
                    <p><strong>Observa√ß√£o:</strong> ${ponto.observacao || 'N/A'}</p>
                    ${ponto.sentimento ? `<p><strong>Sentimento:</strong> ${ponto.sentimento}</p>` : ''}
                    ${ponto.necessidade ? `<p><strong>Necessidade:</strong> ${ponto.necessidade}</p>` : ''}
                    ${ponto.pedido ? `<p><strong>Pedido:</strong> ${ponto.pedido}</p>` : ''}
                    <small><em>Registrado em: ${new Date(ponto.data_criacao).toLocaleDateString('pt-BR')}</em></small>
                </div>
            `;
            
            marker.bindPopup(popupContent, { minWidth: 300, maxHeight: 400 });
            cnvMarkersLayer.addLayer(marker);
        }

        // Mostrar/Esconder formul√°rio
        function toggleCnvForm(visible) {
            if (visible) {
                cnvFormContainer.classList.add('visible');
            } else {
                cnvFormContainer.classList.remove('visible');
                cnvForm.reset();
                document.getElementById('form-action').value = 'criar';
                document.getElementById('form-registro-id-editar').value = '';
                if(submitCnvFormBtn) submitCnvFormBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Enviar Registro';
                if (currentMapClickMarker) {
                    map.removeLayer(currentMapClickMarker);
                    currentMapClickMarker = null;
                }
            }
        }

        // Event Listeners
        cnvFormExpanderButton.addEventListener('click', () => toggleCnvForm(!cnvFormContainer.classList.contains('visible')));
        cancelCnvFormBtn.addEventListener('click', () => toggleCnvForm(false));

        cnvForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!latitudeInput.value || !longitudeInput.value) {
                alert("Clique no mapa para definir a localiza√ß√£o."); 
                return;
            }

            const formData = new FormData(cnvForm);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/?action=registrar-ponto`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const resultado = await response.json();
                
                if (resultado.success) {
                    alert('Registro criado com sucesso!');
                    toggleCnvForm(false);
                    loadMapMarkers();
                } else {
                    alert('Erro: ' + (resultado.mensagem || 'Tente novamente.'));
                }
            } catch (error) {
                console.error('Erro ao criar registro:', error);
                alert('Erro de conex√£o. Tente novamente.');
            }
        });

        // Geolocaliza√ß√£o
        function getUserLocation() {
            if (!navigator.geolocation) {
                alert('Geolocaliza√ß√£o n√£o suportada neste navegador');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 15);
                    if (locationStatusMessage) {
                        locationStatusMessage.textContent = "Localiza√ß√£o encontrada!";
                    }
                },
                error => {
                    let message = 'Erro ao obter localiza√ß√£o: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message += 'Permiss√£o negada';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message += 'Localiza√ß√£o indispon√≠vel';
                            break;
                        case error.TIMEOUT:
                            message += 'Tempo esgotado';
                            break;
                        default:
                            message += 'Erro desconhecido';
                    }
                    if (locationStatusMessage) {
                        locationStatusMessage.textContent = message;
                    }
                }
            );
        }

        // Inicializa√ß√£o
        initMap();
        
        // Pedir localiza√ß√£o ao carregar
        setTimeout(() => {
            getUserLocation();
        }, 1000);

        console.log('üåç Mapa Violeta CNV - Carregado com sucesso!');
    });
    </script>
</body>
</html>
